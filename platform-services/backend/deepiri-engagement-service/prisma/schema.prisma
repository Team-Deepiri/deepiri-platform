// Prisma Schema for Engagement Service
// PostgreSQL database schema - Analytics schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  schemas  = ["analytics", "public"]
}

// Momentum table (analytics schema)
model Momentum {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  totalMomentum     Int       @default(0) @map("total_momentum")
  currentLevel      Int       @default(1) @map("current_level")
  momentumToNextLevel Int     @default(100) @map("momentum_to_next_level")
  
  // Skill mastery counters
  commits            Int       @default(0)
  docs               Int       @default(0)
  tasks              Int       @default(0)
  reviews            Int       @default(0)
  comments           Int       @default(0)
  attendance         Int       @default(0)
  featuresShipped    Int       @default(0) @map("features_shipped")
  designEdits        Int       @default(0) @map("design_edits")
  
  // Public profile settings
  displayMomentum    Boolean   @default(true) @map("display_momentum")
  showcaseAchievements String[] @default([]) @map("showcase_achievements") @db.Uuid
  
  metadata           Json?     @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  levelProgress      LevelProgress[]
  achievements       Achievement[]

  @@index([userId])
  @@index([totalMomentum(sort: Desc)])
  @@index([currentLevel(sort: Desc)])
  @@map("momentum", "analytics")
}

// Level Progress table
model LevelProgress {
  id                String    @id @default(uuid()) @db.Uuid
  momentumId        String    @map("momentum_id") @db.Uuid
  level             Int
  reachedAt         DateTime  @default(now()) @map("reached_at") @db.Timestamp
  totalMomentumAtTime Int     @map("total_momentum_at_time")

  // Relations
  momentum          Momentum  @relation(fields: [momentumId], references: [id], onDelete: Cascade)

  @@index([momentumId])
  @@index([reachedAt(sort: Desc)])
  @@map("level_progress", "analytics")
}

// Achievements table
model Achievement {
  id                String    @id @default(uuid()) @db.Uuid
  momentumId        String    @map("momentum_id") @db.Uuid
  achievementId     String    @map("achievement_id") @db.VarChar(100)
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  iconUrl           String?   @map("icon_url") @db.Text
  rarity            String    @default("common") @db.VarChar(50)
  unlockedAt        DateTime  @default(now()) @map("unlocked_at") @db.Timestamp
  showcaseable      Boolean   @default(false)
  metadata          Json?     @default("{}")

  // Relations
  momentum          Momentum  @relation(fields: [momentumId], references: [id], onDelete: Cascade)

  @@index([momentumId])
  @@index([achievementId])
  @@index([rarity])
  @@map("achievements", "analytics")
}

// Streaks table
model Streak {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  
  // Daily streak
  dailyCurrent      Int       @default(0) @map("daily_current")
  dailyLongest      Int       @default(0) @map("daily_longest")
  dailyLastDate     DateTime? @map("daily_last_date") @db.Date
  dailyCanCashIn    Boolean   @default(false) @map("daily_can_cash_in")
  
  // Weekly streak
  weeklyCurrent     Int       @default(0) @map("weekly_current")
  weeklyLongest     Int       @default(0) @map("weekly_longest")
  weeklyLastWeek    Int?      @map("weekly_last_week")
  weeklyCanCashIn   Boolean   @default(false) @map("weekly_can_cash_in")
  
  // Project streak
  projectCurrent    Int       @default(0) @map("project_current")
  projectLongest    Int       @default(0) @map("project_longest")
  projectId         String?   @map("project_id") @db.Uuid
  projectLastDate   DateTime? @map("project_last_date") @db.Date
  projectCanCashIn  Boolean   @default(false) @map("project_can_cash_in")
  
  // PR/Review streak
  prCurrent         Int       @default(0) @map("pr_current")
  prLongest         Int       @default(0) @map("pr_longest")
  prLastDate        DateTime? @map("pr_last_date") @db.Date
  prCanCashIn       Boolean   @default(false) @map("pr_can_cash_in")
  
  // Healthy/Sustainable streak
  healthyCurrent    Int       @default(0) @map("healthy_current")
  healthyLongest    Int       @default(0) @map("healthy_longest")
  healthyLastDate   DateTime? @map("healthy_last_date") @db.Date
  healthyCanCashIn  Boolean   @default(false) @map("healthy_can_cash_in")
  healthyConsecutiveDaysWithoutBurnout Int @default(0) @map("healthy_consecutive_days_without_burnout")
  
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  cashedInStreaks    CashedInStreak[]

  @@index([userId])
  @@index([dailyCurrent(sort: Desc)])
  @@map("streaks", "analytics")
}

// Cashed In Streaks table
model CashedInStreak {
  id                String    @id @default(uuid()) @db.Uuid
  streakId           String    @map("streak_id") @db.Uuid
  streakType         String    @map("streak_type") @db.VarChar(50)
  streakValue        Int       @map("streak_value")
  boostCreditsEarned Int       @default(0) @map("boost_credits_earned")
  cashedAt           DateTime  @default(now()) @map("cashed_at") @db.Timestamp

  // Relations
  streak             Streak    @relation(fields: [streakId], references: [id], onDelete: Cascade)

  @@index([streakId])
  @@index([cashedAt(sort: Desc)])
  @@map("cashed_in_streaks", "analytics")
}

// Boosts table
model Boost {
  id                String    @id @default(uuid()) @db.Uuid
  userId            String    @unique @map("user_id") @db.Uuid
  boostCredits      Int       @default(0) @map("boost_credits")
  
  // Settings
  maxConcurrentBoosts Int     @default(3) @map("max_concurrent_boosts")
  maxAutopilotTimePerDay Int  @default(0) @map("max_autopilot_time_per_day")
  autopilotTimeUsedToday Int  @default(0) @map("autopilot_time_used_today")
  lastAutopilotReset DateTime? @map("last_autopilot_reset") @db.Date
  
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp

  // Relations
  activeBoosts       ActiveBoost[]
  boostHistory      BoostHistory[]

  @@index([userId])
  @@map("boosts", "analytics")
}

// Active Boosts table
model ActiveBoost {
  id                String    @id @default(uuid()) @db.Uuid
  boostId            String    @map("boost_id") @db.Uuid
  boostType          String    @map("boost_type") @db.VarChar(100)
  activatedAt        DateTime  @default(now()) @map("activated_at") @db.Timestamp
  expiresAt          DateTime  @map("expires_at") @db.Timestamp
  durationMinutes    Int       @map("duration_minutes")
  multiplier         Float     @default(1.0)
  metadata           Json?     @default("{}")

  // Relations
  boost              Boost     @relation(fields: [boostId], references: [id], onDelete: Cascade)

  @@index([boostId])
  @@index([expiresAt])
  @@index([boostType])
  @@map("active_boosts", "analytics")
}

// Boost History table
model BoostHistory {
  id                String    @id @default(uuid()) @db.Uuid
  boostId            String    @map("boost_id") @db.Uuid
  boostType          String    @map("boost_type") @db.VarChar(100)
  activatedAt        DateTime  @map("activated_at") @db.Timestamp
  expiredAt          DateTime? @map("expired_at") @db.Timestamp
  durationMinutes    Int       @map("duration_minutes")
  creditsUsed        Int       @default(0) @map("credits_used")
  source             String?   @db.VarChar(100)
  effectivenessScore Float?    @map("effectiveness_score")
  metadata           Json?     @default("{}")

  // Relations
  boost              Boost     @relation(fields: [boostId], references: [id], onDelete: Cascade)

  @@index([boostId])
  @@index([activatedAt(sort: Desc)])
  @@map("boost_history", "analytics")
}

// Seasons table (public schema)
model Season {
  id                String    @id @default(uuid()) @db.Uuid
  name              String    @db.VarChar(255)
  description       String?   @db.Text
  startDate         DateTime  @map("start_date") @db.Timestamp
  endDate           DateTime? @map("end_date") @db.Timestamp
  isActive          Boolean   @default(false) @map("is_active")
  metadata          Json?     @default("{}")
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamp

  @@index([isActive])
  @@index([startDate])
  @@map("seasons", "public")
}

// Season Boosts table (public schema)
model SeasonBoost {
  id                String    @id @default(uuid()) @db.Uuid
  seasonId           String    @map("season_id") @db.Uuid
  name               String    @db.VarChar(255)
  description        String?   @db.Text
  boostType          String    @map("boost_type") @db.VarChar(100)
  boostMultiplier    Float     @default(1.0) @map("boost_multiplier")
  durationMinutes    Int?      @map("duration_minutes")
  costCredits        Int       @default(0) @map("cost_credits")
  isActive           Boolean   @default(true) @map("is_active")
  metadata           Json?     @default("{}")
  createdAt          DateTime  @default(now()) @map("created_at") @db.Timestamp
  updatedAt          DateTime  @updatedAt @map("updated_at") @db.Timestamp

  @@index([seasonId])
  @@index([boostType])
  @@index([isActive])
  @@map("season_boosts", "public")
}

// Placeholder models for relations
model User {
  id        String   @id @default(uuid()) @db.Uuid
}

model Project {
  id        String   @id @default(uuid()) @db.Uuid
}

